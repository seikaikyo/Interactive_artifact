<!DOCTYPE html>
<html>
<head>
    <title>å®Œæ•´æµç¨‹æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>èªè­‰ç³»çµ±å®Œæ•´æµç¨‹æ¸¬è©¦</h1>

    <div id="results"></div>

    <div>
        <button onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
        <button onclick="clearStorage()">æ¸…é™¤å­˜å„²</button>
        <button onclick="testManagePage()">æ¸¬è©¦ç®¡ç†é é¢</button>
        <button onclick="testLoginPage()">æ¸¬è©¦ç™»å…¥é é¢</button>
        <button onclick="testMainPage()">æ¸¬è©¦ä¸»é é¢</button>
    </div>

    <script type="module">
        import AccountManager from './src/accounts.js';

        let results = [];

        function log(message, type = 'info') {
            results.push({ message, type, time: new Date().toLocaleTimeString() });
            updateDisplay();
        }

        function updateDisplay() {
            const container = document.getElementById('results');
            container.innerHTML = results.map(r => `
                <div class="test ${r.type}">
                    [${r.time}] ${r.message}
                </div>
            `).join('');
        }

        window.clearStorage = () => {
            localStorage.clear();
            sessionStorage.clear();
            results = [];
            log('âœ… å­˜å„²å·²æ¸…é™¤', 'pass');
        };

        window.testManagePage = async () => {
            try {
                log('ğŸ§ª æ¸¬è©¦ç®¡ç†é é¢...', 'info');

                // æ¸…é™¤å­˜å„²
                localStorage.clear();
                sessionStorage.clear();

                // å‰µå»ºå¸³è™Ÿç®¡ç†å™¨
                const accountManager = new AccountManager();
                accountManager.initialize();

                if (accountManager.accounts.length === 0) {
                    log('âœ… ç„¡å¸³è™Ÿç‹€æ…‹æ­£ç¢º', 'pass');

                    // å‰µå»ºç¬¬ä¸€å€‹ç®¡ç†å“¡å¸³è™Ÿ
                    const account = accountManager.createFirstAdminAccount();
                    log(`âœ… å‰µå»ºç®¡ç†å“¡å¸³è™Ÿ: ${account.username}`, 'pass');

                    // é©—è­‰å¸³è™Ÿ
                    const isValid = accountManager.validateAccount(account.username, accountManager.FIXED_PASSWORD);
                    if (isValid) {
                        log('âœ… å¸³è™Ÿé©—è­‰é€šé', 'pass');
                    } else {
                        log('âŒ å¸³è™Ÿé©—è­‰å¤±æ•—', 'fail');
                    }
                } else {
                    log('â„¹ï¸ å·²æœ‰å¸³è™Ÿå­˜åœ¨', 'info');
                }
            } catch (error) {
                log(`âŒ ç®¡ç†é é¢æ¸¬è©¦å¤±æ•—: ${error.message}`, 'fail');
            }
        };

        window.testLoginPage = () => {
            try {
                log('ğŸ§ª æ¸¬è©¦ç™»å…¥é é¢...', 'info');

                const accountManager = new AccountManager();
                accountManager.initialize();

                if (accountManager.accounts.length > 0) {
                    const account = accountManager.accounts[0];

                    // æ¨¡æ“¬ç™»å…¥æˆåŠŸ
                    const authData = {
                        authenticated: true,
                        username: account.username,
                        loginTime: Date.now(),
                        expires: Date.now() + (8 * 3600 * 1000)
                    };

                    sessionStorage.setItem('factoryAuth', JSON.stringify(authData));
                    log('âœ… ç™»å…¥æ¨¡æ“¬æˆåŠŸ', 'pass');

                    // æª¢æŸ¥èªè­‰ç‹€æ…‹
                    const authCheck = sessionStorage.getItem('factoryAuth');
                    if (authCheck) {
                        const auth = JSON.parse(authCheck);
                        const isAuthenticated = Date.now() < auth.expires && auth.authenticated;
                        if (isAuthenticated) {
                            log('âœ… èªè­‰ç‹€æ…‹æ­£ç¢º', 'pass');
                        } else {
                            log('âŒ èªè­‰ç‹€æ…‹éŒ¯èª¤', 'fail');
                        }
                    }
                } else {
                    log('âš ï¸ ç„¡å¸³è™Ÿå¯æ¸¬è©¦ç™»å…¥', 'info');
                }
            } catch (error) {
                log(`âŒ ç™»å…¥é é¢æ¸¬è©¦å¤±æ•—: ${error.message}`, 'fail');
            }
        };

        window.testMainPage = () => {
            try {
                log('ğŸ§ª æ¸¬è©¦ä¸»é é¢èªè­‰æª¢æŸ¥...', 'info');

                // æ¸¬è©¦ç„¡èªè­‰ç‹€æ…‹
                sessionStorage.removeItem('factoryAuth');

                const authData = sessionStorage.getItem('factoryAuth');
                if (!authData) {
                    log('âœ… ç„¡èªè­‰ç‹€æ…‹æª¢æŸ¥æ­£ç¢º', 'pass');
                } else {
                    log('âŒ ç„¡èªè­‰ç‹€æ…‹æª¢æŸ¥å¤±æ•—', 'fail');
                }

                // æ¸¬è©¦æœ‰èªè­‰ç‹€æ…‹
                const validAuth = {
                    authenticated: true,
                    username: 'TEST123456A',
                    loginTime: Date.now(),
                    expires: Date.now() + (8 * 3600 * 1000)
                };

                sessionStorage.setItem('factoryAuth', JSON.stringify(validAuth));

                const checkAuth = sessionStorage.getItem('factoryAuth');
                if (checkAuth) {
                    const auth = JSON.parse(checkAuth);
                    const isValid = Date.now() < auth.expires && auth.authenticated;
                    if (isValid) {
                        log('âœ… æœ‰æ•ˆèªè­‰ç‹€æ…‹æª¢æŸ¥æ­£ç¢º', 'pass');
                    } else {
                        log('âŒ æœ‰æ•ˆèªè­‰ç‹€æ…‹æª¢æŸ¥å¤±æ•—', 'fail');
                    }
                }
            } catch (error) {
                log(`âŒ ä¸»é é¢æ¸¬è©¦å¤±æ•—: ${error.message}`, 'fail');
            }
        };

        window.runAllTests = async () => {
            results = [];
            log('ğŸš€ é–‹å§‹å®Œæ•´æµç¨‹æ¸¬è©¦', 'info');

            await window.testManagePage();
            await new Promise(resolve => setTimeout(resolve, 500));

            await window.testLoginPage();
            await new Promise(resolve => setTimeout(resolve, 500));

            await window.testMainPage();

            log('ğŸ æ‰€æœ‰æ¸¬è©¦å®Œæˆ', 'info');
        };

        // è‡ªå‹•é‹è¡Œæ¸¬è©¦
        window.addEventListener('load', () => {
            log('ğŸ”§ æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ', 'pass');
        });
    </script>
</body>
</html>